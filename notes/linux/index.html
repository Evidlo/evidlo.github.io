<!DOCTYPE html>
<html lang="en">

<head>
    <title>Linux Notes</title>
    <meta name="viewport" content="width=device-width"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="/styles.css" /> 
    <link rel="stylesheet" type="text/css" href="/codehilite.css" /> 
    <link rel="alternate" type="application/rss+xml" href="/rss.html" title="RSS feed">
</head>
<body>
    <main>
        
<article>
<header>
    <h1>Linux Notes</h1>
    <time datetime=""></time>
</header>
<div class="toc">
<ul>
<li><a href="#systemd">systemd</a><ul>
<li><a href="#commands">Commands</a></li>
<li><a href="#examples">Examples</a></li>
</ul>
</li>
<li><a href="#basic-arch-install">Basic Arch Install</a></li>
<li><a href="#generic-linux-install">Generic Linux Install</a></li>
<li><a href="#udev">udev</a></li>
<li><a href="#iptables">iptables</a><ul>
<li><a href="#commands_1">Commands</a></li>
<li><a href="#examples_1">Examples</a></li>
</ul>
</li>
<li><a href="#iperf">iperf</a></li>
<li><a href="#lvm">LVM</a><ul>
<li><a href="#adding">Adding</a></li>
</ul>
</li>
<li><a href="#deleting">Deleting</a><ul>
<li><a href="#btrfs">BTRFS</a></li>
</ul>
</li>
<li><a href="#lxc">LXC</a><ul>
<li><a href="#config-examples">Config examples</a></li>
<li><a href="#commands_2">Commands</a></li>
<li><a href="#new-container-setup">New Container Setup</a><ul>
<li><a href="#debian">Debian</a></li>
<li><a href="#fedora">Fedora</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#weechat">Weechat</a></li>
<li><a href="#mdadm">MDADM</a><ul>
<li><a href="#checking-state-and-simulating-failure">Checking state and simulating failure</a></li>
<li><a href="#replacing-a-failed-drive-sdc">Replacing a failed drive (sdc)</a></li>
<li><a href="#notifying-on-harddrive-failure-gmail">Notifying on harddrive failure (gmail)</a></li>
<li><a href="#growing-raid-size">Growing RAID size</a></li>
<li><a href="#accessing-via-live-cd">Accessing via Live CD</a></li>
</ul>
</li>
<li><a href="#installing-grub-on-a-live-cd-mounted-system">Installing GRUB on a Live CD Mounted System</a></li>
<li><a href="#mounting-images">Mounting Images</a></li>
<li><a href="#auto-fs">Auto FS</a></li>
<li><a href="#resizing-luks-encrypted-lvm">Resizing LUKS encrypted LVM</a></li>
<li><a href="#fixing-nodejs">Fixing Nodejs</a></li>
<li><a href="#rsync">Rsync</a></li>
<li><a href="#dns-tunneling-with-iodine">DNS Tunneling with iodine</a><ul>
<li><a href="#domain-setup">Domain Setup</a></li>
<li><a href="#server-setup">Server Setup</a></li>
<li><a href="#client-setup">Client Setup</a></li>
</ul>
</li>
<li><a href="#dns">DNS</a></li>
<li><a href="#booting">Booting</a></li>
<li><a href="#gpt-guid-partition-table">GPT - GUID Partition Table</a></li>
<li><a href="#random-facts">Random facts</a></li>
<li><a href="#smart-status">SMART Status</a></li>
<li><a href="#network-interfaces-and-bridging">Network interfaces and bridging</a><ul>
<li><a href="#simulating-network-disconnect">Simulating network disconnect</a></li>
</ul>
</li>
<li><a href="#ubuntu-vnc-server">Ubuntu VNC Server</a></li>
<li><a href="#buildroot">Buildroot</a><ul>
<li><a href="#useful-options">Useful options</a></li>
</ul>
</li>
<li><a href="#fedora-copr">Fedora COPR</a></li>
<li><a href="#broken-tty">Broken TTY</a></li>
<li><a href="#qemu">QEMU</a></li>
<li><a href="#playing-sound">Playing Sound</a></li>
<li><a href="#connecting-to-multiple-wifi-networks-simultaneously">Connecting to Multiple WiFi Networks Simultaneously</a></li>
<li><a href="#nmcli">NMCLI</a></li>
<li><a href="#flatpak-filesystem-access">Flatpak Filesystem Access</a></li>
<li><a href="#syncthing-cli">Syncthing CLI</a></li>
<li><a href="#nmap">NMAP</a></li>
<li><a href="#annoying-people-with-mpv">Annoying People with MPV</a></li>
</ul>
</div>
<h2 id="systemd"><a class="toclink" href="#systemd">systemd</a></h2>
<p><strong>/etc/systemd/system</strong> - default location for system units
<strong>~/.config/systemd/user</strong> - default location for user units</p>
<h3 id="commands"><a class="toclink" href="#commands">Commands</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># reload units and timers</span>
systemctl<span class="w"> </span><span class="o">[</span>--user<span class="o">]</span><span class="w"> </span>daemon-reload
<span class="c1"># show all units (including disabled)</span>
systemctl<span class="w"> </span><span class="o">[</span>--user<span class="o">]</span><span class="w"> </span>list-units<span class="w"> </span>-a
<span class="c1"># view logs for unit</span>
<span class="c1"># also accepts:</span>
<span class="c1">#   -f               | tail the log</span>
<span class="c1">#   --user-unit foo  | target user unit instead of system</span>
<span class="c1">#   --boot=0         | show logs from current boot (-1 for previous, etc)</span>
journalctl<span class="w"> </span>--unit<span class="w"> </span>foo
</code></pre></div>

<h3 id="examples"><a class="toclink" href="#examples">Examples</a></h3>
<p>A simple service unit</p>
<p><strong>foobar.service</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">example service</span>

<span class="k">[Service]</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/path/to/dir</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">&quot;FOOBAR=foo&quot;</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">foobar.sh</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>

<p><strong>foobar.timer</strong> A simple timer unit</p>
<div class="codehilite"><pre><span></span><code>[Unit]
Description=example timer

[Timer]
# run every 15 minutes (aligns to the hour)
OnCalendar=*:0/15
# run timer immediately if script is enabled and is past due
Persistent=true

[Install]
WantedBy=timers.target
</code></pre></div>

<p>More examples <a href="http://github.com/evidlo/examples/tree/master/systemd">here</a>.</p>
<h2 id="basic-arch-install"><a class="toclink" href="#basic-arch-install">Basic Arch Install</a></h2>
<div class="codehilite"><pre><span></span><code>dhcpcd

timedatectl<span class="w"> </span>set-ntp<span class="w"> </span><span class="nb">true</span>


fdisk<span class="w"> </span>/dev/sda<span class="w"> </span>

<span class="c1"># Create 300MB boot, 2GB swap, and leave the rest for root</span>

mkswp<span class="w"> </span>/dev/sda2

mkfs.ext4<span class="w"> </span>/dev/sda3

mount<span class="w"> </span>/dev/sda3<span class="w"> </span>/mnt

swapon<span class="w"> </span>/dev/sda2

<span class="c1"># edit /etc/pacman.d/mirrorlist to change mirror order **</span>

pacstrap<span class="w"> </span>/mnt<span class="w"> </span>base

genfstab<span class="w"> </span>-p<span class="w"> </span>/mnt<span class="w"> </span>&gt;&gt;<span class="w"> </span>/mnt/etc/fstab

arch-chroot<span class="w"> </span>/mnt

ln<span class="w"> </span>-s<span class="w"> </span>/usr/share/zoneinfo/America/Indianapolis<span class="w"> </span>/etc/localtime

hwclock<span class="w"> </span>--systohc<span class="w"> </span>--utc

<span class="c1"># uncomment en_US locales in /etc/locale.gen **</span>

locale-gen

<span class="c1"># enter hostname in /etc/hostname **</span>

mkinitcpio<span class="w"> </span>-p<span class="w"> </span>linux

passwd

pacman<span class="w"> </span>-S<span class="w"> </span>grub

grub-install<span class="w"> </span>--target<span class="o">=</span>i386-pc<span class="w"> </span>--recheck<span class="w"> </span>--debug<span class="w"> </span>/dev/sda

grub-mkconfig<span class="w"> </span>-o<span class="w"> </span>/boot/grub/grub.cfg

<span class="nb">exit</span>

reboot

pacman<span class="w"> </span>-S<span class="w"> </span>vim<span class="w"> </span>htop<span class="w"> </span>git<span class="w"> </span>openssh<span class="w"> </span>wget

pacman<span class="w"> </span>-S<span class="w"> </span>xorg-server<span class="w"> </span>xf86-video-ati<span class="w"> </span>xorg-xinit
</code></pre></div>

<h2 id="generic-linux-install"><a class="toclink" href="#generic-linux-install">Generic Linux Install</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># list all available block devices</span>
lsblk
<span class="c1"># Copy bootable image to flash drive (status=progress requires dd &gt;= 8.24)</span>
<span class="c1"># be careful not to mess up the of= argument, or you might overwrite your HD</span>
sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>foobar.iso<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/sdX<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sync
</code></pre></div>

<h2 id="udev"><a class="toclink" href="#udev">udev</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># show device connect/disconnects and fired rules</span>
udevadm<span class="w"> </span>monitor
<span class="c1"># list all attributes for a particular device (and parents)</span>
udevadm<span class="w"> </span>info<span class="w"> </span>--attribute-walk<span class="w"> </span>--path<span class="o">=</span>/devices/...
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># simple vendorid, productid example</span>
<span class="c1"># note SYMLINK is only for block devices (I think, look it up yourself)</span>
<span class="nv">SUBSYSTEMS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>,<span class="w"> </span>ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">&quot;3300&quot;</span>,<span class="w"> </span>ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">&quot;1e10&quot;</span>,<span class="w"> </span><span class="nv">MODE</span><span class="o">=</span><span class="s2">&quot;0666&quot;</span>,<span class="w"> </span><span class="nv">SYMLINK</span><span class="o">+=</span><span class="s2">&quot;foobar&quot;</span>
</code></pre></div>

<h2 id="iptables"><a class="toclink" href="#iptables">iptables</a></h2>
<h3 id="commands_1"><a class="toclink" href="#commands_1">Commands</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># list all tables</span>
iptables<span class="w"> </span>-L<span class="w"> </span>-n<span class="w"> </span>-v
<span class="c1"># (fedora) save iptables rules and remember to disable firewalld</span>
iptables-save<span class="w"> </span>&gt;<span class="w"> </span>/etc/sysconfig/iptables
</code></pre></div>

<h3 id="examples_1"><a class="toclink" href="#examples_1">Examples</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># allow ssh</span>
<span class="c1"># must allow incoming connection and response</span>

<span class="c1"># append rule to input (-A INPUT) on input interface enp6s0f0 (-i enp6s0f0) </span>
<span class="c1"># with destination port 22 (--dport 22).  use &#39;state&#39; module (-m state)</span>
<span class="c1"># and allow new and established connections (--state NEW,ESTABLISHED)</span>
<span class="c1"># jump to target ACCEPT (-j ACCEPT)</span>
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span>enp6s0f0<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">22</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># append rule to output (-A OUTPUT) on output interface enp6s0f0 (-o enp6s0f0) </span>
<span class="c1"># with source port 22 (--sport 22).  use &#39;state&#39; module (-m state)</span>
<span class="c1"># and allow established connections (--state ESTABLISHED)</span>
<span class="c1"># jump to target ACCEPT (-j ACCEPT)</span>
iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-o<span class="w"> </span>enp6s0f0<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--sport<span class="w"> </span><span class="m">22</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># filter table: flush all chains, and delete all user added chains</span>
iptables<span class="w"> </span>-F
iptables<span class="w"> </span>-X
<span class="c1"># nat table: flush all chains, and delete all user added chains</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-F
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-X
</code></pre></div>

<h2 id="iperf"><a class="toclink" href="#iperf">iperf</a></h2>
<p>Do network bandwidth testing</p>
<p>Test speed to device A for 10 s</p>
<div class="codehilite"><pre><span></span><code><span class="n">iperf</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">[</span><span class="n">other_ip</span><span class="o">]</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">[</span><span class="n">other_port</span><span class="o">]</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">M</span>
</code></pre></div>

<p>Wait for connection from device B</p>
<div class="codehilite"><pre><span></span><code>iperf -s -p 1234
</code></pre></div>

<h2 id="lvm"><a class="toclink" href="#lvm">LVM</a></h2>
<h3 id="adding"><a class="toclink" href="#adding">Adding</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># create new lv `foo` in group `foo_group`</span>
lvcreate<span class="w"> </span>-L<span class="w"> </span>10G<span class="w"> </span>foo_group<span class="w"> </span>-n<span class="w"> </span>foo
</code></pre></div>

<h2 id="deleting"><a class="toclink" href="#deleting">Deleting</a></h2>
<div class="codehilite"><pre><span></span><code>lvremove<span class="w"> </span>/dev/<span class="o">[</span>vgname<span class="o">]</span>/<span class="o">[</span>lvname<span class="o">]</span>
</code></pre></div>

<h3 id="btrfs"><a class="toclink" href="#btrfs">BTRFS</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># add all devices to filesystem</span>
btrfs<span class="w"> </span>device<span class="w"> </span>add<span class="w"> </span>/dev/sdb2<span class="w"> </span>/dev/sdc2<span class="w"> </span>/dev/sdd2<span class="w"> </span>/
<span class="c1"># convert system to raid10</span>
btrfs<span class="w"> </span>balance<span class="w"> </span>start<span class="w"> </span>-dconvert<span class="o">=</span>raid10<span class="w"> </span>-mconvert<span class="o">=</span>raid10<span class="w"> </span>/
<span class="c1"># check balance progress</span>
btrfs<span class="w"> </span>balance<span class="w"> </span>status<span class="w"> </span>/
<span class="c1"># get rid of single chunks to get another shot at degraded,rw mount</span>
btrfs<span class="w"> </span>balance<span class="w"> </span>start<span class="w"> </span>-dconvert<span class="o">=</span>raid10,soft<span class="w"> </span>-mconvert<span class="o">=</span>raid10,soft<span class="w">  </span>/mount
</code></pre></div>

<h2 id="lxc"><a class="toclink" href="#lxc">LXC</a></h2>
<p><a href="https://www.flockport.com/enable-lxc-networking-in-debian-jessie-fedora-and-others/">https://www.flockport.com/enable-lxc-networking-in-debian-jessie-fedora-and-others/</a></p>
<h3 id="config-examples"><a class="toclink" href="#config-examples">Config examples</a></h3>
<p><strong>/etc/lxc/lxc.conf</strong> - set path for containers to be stored (default
/var/lib/lxc)</p>
<div class="codehilite"><pre><span></span><code>lxc.lxcpath<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/lxc&quot;</span>
</code></pre></div>

<p><strong>/etc/lxc/default.conf</strong> - config options for all newly created
containers to inherit</p>
<div class="codehilite"><pre><span></span><code>lxc.network.type<span class="w"> </span><span class="o">=</span><span class="w"> </span>veth
lxc.network.link<span class="w"> </span><span class="o">=</span><span class="w"> </span>lxcbr0
lxc.network.flags<span class="w"> </span><span class="o">=</span><span class="w"> </span>up
lxc.network.hwaddr<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">00</span>:16:3e:xx:xx:xx
lxc.start.auto<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>

<span class="c1"># address</span>
<span class="c1">#lxc.network.ipv4 = 192.168.1.1xx</span>
lxc.network.ipv4.gateway<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">192</span>.168.1.1

<span class="c1"># memory</span>
lxc.cgroup.memory.limit_in_bytes<span class="w"> </span><span class="o">=</span><span class="w"> </span>512M

<span class="c1"># memory + swap</span>
lxc.cgroup.memory.memsw.limit_in_bytes<span class="w"> </span><span class="o">=</span><span class="w"> </span>1G
</code></pre></div>

<p><strong>/etc/default/lxc-net</strong> - it may be necessary to add
/etc/lxc/dnsasq.conf to the apparmor profile
(/etc/apparmor.d/<em>dnsmasq</em>) with read privileges</p>
<div class="codehilite"><pre><span></span><code><span class="nv">USE_LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nv">LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;lxcbr0&quot;</span>
<span class="nv">LXC_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.1.1&quot;</span>
<span class="nv">LXC_NETMASK</span><span class="o">=</span><span class="s2">&quot;255.255.255.0&quot;</span>
<span class="nv">LXC_NETWORK</span><span class="o">=</span><span class="s2">&quot;192.168.1.0/24&quot;</span>
<span class="nv">LXC_DHCP_RANGE</span><span class="o">=</span><span class="s2">&quot;192.168.1.100,192.168.1.199&quot;</span>
<span class="nv">LXC_DHCP_MAX</span><span class="o">=</span><span class="s2">&quot;100&quot;</span>
<span class="nv">LXC_DHCP_CONFILE</span><span class="o">=</span><span class="s2">&quot;/etc/lxc/dnsmasq.conf&quot;</span>
<span class="nv">LXC_DOMAIN</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</code></pre></div>

<p><strong>/etc/lxc/dnsmasq.conf</strong></p>
<div class="codehilite"><pre><span></span><code>dhcp-host<span class="o">=</span>evan,192.168.1.102
</code></pre></div>

<p><strong>iptables config</strong></p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">## Evan Widloski - 2016-11-11</span>
<span class="c1"># Diode iptables rules</span>

<span class="c1"># filter table: flush all chains, and delete all user added chains</span>
iptables<span class="w"> </span>-F
iptables<span class="w"> </span>-X
<span class="c1"># nat table: flush all chains, and delete all user added chains</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-F
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-X

<span class="c1"># set default policies to DROP packets</span>
iptables<span class="w"> </span>-P<span class="w"> </span>INPUT<span class="w"> </span>DROP
iptables<span class="w"> </span>-P<span class="w"> </span>OUTPUT<span class="w"> </span>DROP
iptables<span class="w"> </span>-P<span class="w"> </span>FORWARD<span class="w"> </span>DROP

<span class="c1"># allow inbound outbound traffic on host </span>
iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-o<span class="w"> </span>enp6s0f0<span class="w"> </span>-d<span class="w"> </span><span class="m">0</span>.0.0.0/0<span class="w"> </span>-j<span class="w"> </span>ACCEPT<span class="w"> </span>
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span>enp6s0f0<span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED,RELATED<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># set up chain for sshguard</span>
iptables<span class="w"> </span>-N<span class="w"> </span>sshguard
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">22</span><span class="w"> </span>-j<span class="w"> </span>sshguard

<span class="c1"># allow ssh</span>
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span>enp6s0f0<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">22</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-o<span class="w"> </span>enp6s0f0<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--sport<span class="w"> </span><span class="m">22</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># allow mosh</span>
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span>enp6s0f0<span class="w"> </span>-p<span class="w"> </span>udp<span class="w"> </span>--dport<span class="w"> </span><span class="m">60000</span>:61000<span class="w"> </span>-j<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-o<span class="w"> </span>enp6s0f0<span class="w"> </span>-p<span class="w"> </span>udp<span class="w"> </span>--sport<span class="w"> </span><span class="m">60000</span>:61000<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># allow connections to varnish service</span>
<span class="c1">#iptables -A INPUT -i enp6s0f0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span>
<span class="c1">#iptables -A OUTPUT -o enp6s0f0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT</span>

<span class="c1"># allow host to access LXC targets via network</span>
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED,RELATED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.1.0/24<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># allow outbound traffic for lxc containers</span>
iptables<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span>lxcbr0<span class="w"> </span>-j<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.1.0/24<span class="w"> </span>-j<span class="w"> </span>MASQUERADE

<span class="c1"># after incoming packets have been NAT&#39;ed (see below), allow them to pass through</span>
<span class="c1"># the forward chain to their intended LXC target</span>
iptables<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW,ESTABLISHED,RELATED<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1">##------------ evan --------------</span>
<span class="c1">## ssh</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">20022</span><span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to-destination<span class="w"> </span><span class="m">192</span>.168.1.102:22
</code></pre></div>

<h3 id="commands_2"><a class="toclink" href="#commands_2">Commands</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># list container statuses and ip addresses (fancy mode)</span>
lxc-ls<span class="w"> </span>-f
</code></pre></div>

<div class="codehilite"><pre><span></span><code>brctl<span class="w"> </span>show
brctl<span class="w"> </span>delbr<span class="w"> </span>virbr0
brctl<span class="w"> </span>addbr<span class="w"> </span>virbr0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>virbr0<span class="w"> </span>down
</code></pre></div>

<h3 id="new-container-setup"><a class="toclink" href="#new-container-setup">New Container Setup</a></h3>
<p>New LXC containers are very barebones and need a bit of setup to be
useful. Here is an overview of steps for various distros.</p>
<h4 id="debian"><a class="toclink" href="#debian">Debian</a></h4>
<p>Setup PATH</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># add /bin, /sbin to path</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;PATH=$PATH:/bin:/sbin&#39;</span>&gt;&gt;.bashrc
</code></pre></div>

<p>Install packages</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># core commands</span>
apt-get<span class="w"> </span>install<span class="w"> </span>apt-utils<span class="w"> </span>vim<span class="w"> </span>man<span class="w"> </span>tar<span class="w"> </span>less<span class="w"> </span>iputils-ping

<span class="c1"># extra commands</span>
apt-get<span class="w"> </span>install<span class="w"> </span>git<span class="w"> </span>zip<span class="w"> </span>autojump<span class="w"> </span>wget<span class="w"> </span>htop<span class="w"> </span>ncdu<span class="w"> </span>nload
</code></pre></div>

<h4 id="fedora"><a class="toclink" href="#fedora">Fedora</a></h4>
<p>Install packages</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># core commands</span>
dnf<span class="w"> </span>install<span class="w"> </span>vim<span class="w"> </span>man

<span class="c1"># core commands</span>
dnf<span class="w"> </span>install<span class="w"> </span>git<span class="w"> </span>zip<span class="w"> </span>autojump<span class="w"> </span>wget<span class="w"> </span>htop<span class="w"> </span>ncdu<span class="w"> </span>nload
</code></pre></div>

<h2 id="weechat"><a class="toclink" href="#weechat">Weechat</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># enable notifications for any messages in buffer (works for Android client, too)</span>
/buffer<span class="w"> </span><span class="nb">set</span><span class="w"> </span>highlight_regex<span class="w"> </span>.<span class="se">\a</span>st<span class="o">{}</span>.*
</code></pre></div>

<h2 id="mdadm"><a class="toclink" href="#mdadm">MDADM</a></h2>
<h3 id="checking-state-and-simulating-failure"><a class="toclink" href="#checking-state-and-simulating-failure">Checking state and simulating failure</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># check RAID state</span>
cat<span class="w"> </span>/proc/mdstat<span class="w">  </span><span class="c1"># look for failure, (F), after the drive name: sda1[0](F)</span>

<span class="c1"># simulate a failed drive</span>
mdadm<span class="w"> </span>--manage<span class="w"> </span>--set-faulty<span class="w"> </span>/dev/md/pv00<span class="w"> </span>/dev/sda1

<span class="c1"># remove faulty state by removing and readding</span>
mdadm<span class="w"> </span>--remove<span class="w"> </span>/dev/md/pv00<span class="w"> </span>/dev/sda1
mdadm<span class="w"> </span>--add<span class="w"> </span>/dev/md/pv00<span class="w"> </span>/dev/sda1
</code></pre></div>

<h3 id="replacing-a-failed-drive-sdc"><a class="toclink" href="#replacing-a-failed-drive-sdc">Replacing a failed drive (sdc)</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># set hard drive as failed</span>
<span class="c1"># mark as failed and remove</span>
mdadm<span class="w"> </span>--manage<span class="w"> </span>/dev/md127<span class="w"> </span>--fail<span class="w"> </span>/dev/sdc1
mdadm<span class="w"> </span>--manage<span class="w"> </span>/dev/md127<span class="w"> </span>--remove<span class="w"> </span>/dev/sdc1

<span class="c1"># write down serial number of failed drive</span>
hdparm<span class="w"> </span>-i<span class="w"> </span>/dev/sdc1<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>serial
shutdown<span class="w"> </span>-h<span class="w"> </span>now
<span class="c1"># remove broken harddrive, insert the new hardddrive</span>

<span class="c1"># copy partition scheme from working harddrive to new harddrive</span>
sfdisk<span class="w"> </span>-d<span class="w"> </span>/dev/sda<span class="w"> </span><span class="p">|</span><span class="w"> </span>sfdisk<span class="w"> </span>/dev/sdc

<span class="c1"># add new harddrive</span>
mdadm<span class="w"> </span>--manage<span class="w"> </span>/dev/md127<span class="w"> </span>--add<span class="w"> </span>/dev/sdc1

<span class="c1"># verify that array is recovering</span>
cat<span class="w"> </span>/proc/mdstat
</code></pre></div>

<h3 id="notifying-on-harddrive-failure-gmail"><a class="toclink" href="#notifying-on-harddrive-failure-gmail">Notifying on harddrive failure (gmail)</a></h3>
<p><strong>/etc/exim/exim.conf</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># add this after `begin routers` in router config section</span>
 <span class="n">send_via_gmail</span><span class="p">:</span>
     <span class="n">driver</span> <span class="o">=</span> <span class="n">manualroute</span>
     <span class="n">domains</span> <span class="o">=</span> <span class="err">!</span> <span class="o">+</span><span class="n">local_domains</span>
     <span class="n">transport</span> <span class="o">=</span> <span class="n">gmail_smtp</span>
     <span class="n">route_list</span> <span class="o">=</span> <span class="o">*</span> <span class="n">gmail</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
<span class="c1"># add this after `begin transports` in transports config section</span>
 <span class="n">gmail_smtp</span><span class="p">:</span>
     <span class="n">driver</span> <span class="o">=</span> <span class="n">smtp</span>
     <span class="n">port</span> <span class="o">=</span> <span class="mi">587</span>
     <span class="n">hosts_require_auth</span> <span class="o">=</span> <span class="n">gmail</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
     <span class="n">hosts_require_tls</span> <span class="o">=</span> <span class="n">gmail</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
<span class="c1"># add this after `begin authenaticators` in authentication config section</span>
 <span class="n">gmail_login</span><span class="p">:</span>
     <span class="n">driver</span> <span class="o">=</span> <span class="n">plaintext</span>
     <span class="n">public_name</span> <span class="o">=</span> <span class="n">LOGIN</span>
     <span class="n">client_send</span> <span class="o">=</span> <span class="p">:</span> <span class="n">sender_email</span><span class="nd">@gmail</span><span class="o">.</span><span class="n">com</span> <span class="p">:</span> <span class="n">password_in_plaintext_here</span>
</code></pre></div>

<p><strong>/etc/mdadm.conf</strong></p>
<div class="codehilite"><pre><span></span><code>MAILADDR destination_email@example.com
AUTO +imsm +1.x -all
ARRAY /dev/md/pv00 level=raid5 num-devices=4 UUID=1327a02b:b19f6696:0e3f8ac7:9615591c
</code></pre></div>

<h3 id="growing-raid-size"><a class="toclink" href="#growing-raid-size">Growing RAID size</a></h3>
<p>This is useful if the RAID array needs to be grown by using up more free
space (no added harddrive)</p>
<div class="codehilite"><pre><span></span><code>umount<span class="w"> </span>/dev/sda
umount<span class="w"> </span>/dev/sdb
umount<span class="w"> </span>/dev/sdc
umount<span class="w"> </span>/dev/sdd

<span class="c1"># grow RAID array to 500GB (this will take a while)</span>
mdadm<span class="w"> </span>-G<span class="w"> </span>/dev/md127<span class="w"> </span>-z<span class="w"> </span>500G

<span class="c1"># resize physical volume to fit new RAID partition size</span>
pvresize<span class="w"> </span>/dev/md127
</code></pre></div>

<h3 id="accessing-via-live-cd"><a class="toclink" href="#accessing-via-live-cd">Accessing via Live CD</a></h3>
<p>If the array gets screwed up somehow, you can try mounting it on a
livecd.</p>
<div class="codehilite"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>mdadm

<span class="c1"># assemble array from block devices</span>
mdadm<span class="w"> </span>--assemble<span class="w"> </span>--scan

<span class="c1"># mount array (assuming lvm)</span>
apt<span class="w"> </span>install<span class="w"> </span>lvm2

<span class="c1"># see if lv&#39;s are intact</span>
lvscan

<span class="c1"># mount lv</span>
mount<span class="w"> </span>/dev/<span class="o">[</span>vgname<span class="o">]</span>/<span class="o">[</span>lvname<span class="o">]</span><span class="w"> </span>/mnt/foo
</code></pre></div>

<h2 id="installing-grub-on-a-live-cd-mounted-system"><a class="toclink" href="#installing-grub-on-a-live-cd-mounted-system">Installing GRUB on a Live CD Mounted System</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># mount root lv</span>
mount<span class="w"> </span>/dev/<span class="o">[</span>vgname<span class="o">]</span>/root<span class="w"> </span>/mnt/root

<span class="c1"># mount live CD directories inside mounted lv</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span>/dev<span class="w"> </span>/dev/pts<span class="w"> </span>/proc<span class="w"> </span>/sys<span class="w"> </span>/run<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sudo<span class="w"> </span>mount<span class="w"> </span>-B<span class="w"> </span><span class="nv">$i</span><span class="w"> </span>/mnt/root<span class="nv">$i</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="c1"># chroot into root lv</span>
chroot<span class="w"> </span>/mnt/root

<span class="c1"># install grub to each device in array</span>
grub2-install<span class="w"> </span>/dev/sda
grub2-install<span class="w"> </span>/dev/sdb
grub2-install<span class="w"> </span>/dev/sdc
grub2-install<span class="w"> </span>/dev/sdd

<span class="c1"># update grub config</span>
grub2-mkconfig<span class="w"> </span>-o<span class="w"> </span>/boot/grub2/grub.cfg
</code></pre></div>

<h2 id="mounting-images"><a class="toclink" href="#mounting-images">Mounting Images</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># list the partitions on the image file</span>
fdisk<span class="w"> </span>-l<span class="w"> </span>/tmp/sdcard.img<span class="w"> </span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nx">Disk</span><span class="w"> </span><span class="o">/</span><span class="nx">tmp</span><span class="o">/</span><span class="nx">sdcard</span><span class="p">.</span><span class="nx">img</span><span class="p">:</span><span class="w"> </span><span class="mi">162</span><span class="w"> </span><span class="nx">MiB</span><span class="p">,</span><span class="w"> </span><span class="mi">169869824</span><span class="w"> </span><span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="mi">331777</span><span class="w"> </span><span class="nx">sectors</span>
<span class="nx">Units</span><span class="p">:</span><span class="w"> </span><span class="nx">sectors</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nx">bytes</span>
<span class="nx">Sector</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="p">(</span><span class="nx">logical</span><span class="o">/</span><span class="nx">physical</span><span class="p">):</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nx">bytes</span>
<span class="nx">I</span><span class="o">/</span><span class="nx">O</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="p">(</span><span class="nx">minimum</span><span class="o">/</span><span class="nx">optimal</span><span class="p">):</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="nx">bytes</span>
<span class="nx">Disklabel</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="nx">dos</span>
<span class="nx">Disk</span><span class="w"> </span><span class="nx">identifier</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00000000</span>

<span class="nx">Device</span><span class="w">           </span><span class="nx">Boot</span><span class="w"> </span><span class="nx">Start</span><span class="w">    </span><span class="nx">End</span><span class="w"> </span><span class="nx">Sectors</span><span class="w">  </span><span class="nx">Size</span><span class="w"> </span><span class="nx">Id</span><span class="w"> </span><span class="nx">Type</span>
<span class="o">/</span><span class="nx">tmp</span><span class="o">/</span><span class="nx">sdcard</span><span class="p">.</span><span class="nx">img1</span><span class="w"> </span><span class="o">*</span><span class="w">        </span><span class="mi">1</span><span class="w">  </span><span class="mi">65536</span><span class="w">   </span><span class="mi">65536</span><span class="w">   </span><span class="mi">32</span><span class="nx">M</span><span class="w">  </span><span class="nx">c</span><span class="w"> </span><span class="nx">W95</span><span class="w"> </span><span class="nx">FAT32</span><span class="w"> </span><span class="p">(</span><span class="nx">LBA</span><span class="p">)</span>
<span class="o">/</span><span class="nx">tmp</span><span class="o">/</span><span class="nx">sdcard</span><span class="p">.</span><span class="nx">img2</span><span class="w">      </span><span class="mi">65537</span><span class="w"> </span><span class="mi">331776</span><span class="w">  </span><span class="mi">266240</span><span class="w">  </span><span class="mi">130</span><span class="nx">M</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="nx">Linux</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># use the sector size and the partition start sector to calculate offset (512 * 65537)</span>
sudo<span class="w"> </span>mount<span class="w"> </span>-o<span class="w"> </span>loop,offset<span class="o">=</span><span class="m">33554944</span><span class="w"> </span>/tmp/sdcard.img<span class="w"> </span>/mnt/tmp
</code></pre></div>

<h2 id="auto-fs"><a class="toclink" href="#auto-fs">Auto FS</a></h2>
<p>Auto FS + SSHFS allows the system to mount ssh filesystems on access and
then automatically unmount after a certain timeout. The necessary tools
are <strong>autofs</strong> and <strong>sshfs</strong>.</p>
<p><strong>/etc/auto.master</strong> or <strong>/etc/auto.master.d/foobar.autofs</strong> or
<strong>/etc/autofs/auto.master</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># mounts all the entries listed in /etc/auto.sshfs in /mnt/ with the given options</span>
<span class="c1"># add the --verbose option here to debug mounting issues</span>
<span class="c1"># set --timeout to control when sshfs mount is automatically unmounted</span>
/mnt<span class="w"> </span>/etc/auto.sshfs<span class="w"> </span>--timeout<span class="o">=</span><span class="m">180</span><span class="w"> </span>--ghost
</code></pre></div>

<p><strong>/etc/auto.sshfs</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># make a mount to be used by auto.master</span>
foobar<span class="w"> </span>-fstype<span class="o">=</span>fuse,rw,IdentityFile<span class="o">=</span>/home/evan/.ssh/foobar,port<span class="o">=</span><span class="m">22</span>,allow_other<span class="w"> </span>:sshfs#foo@example.org:
</code></pre></div>

<p>AutoFS runs as root, so ensure that the host fingerprint has been added
to <strong><em>root</em>.ssh/known_hosts</strong>. You can add this easily by attempting to
ssh login to foo@example.org from root.</p>
<div class="codehilite"><pre><span></span><code>su<span class="w"> </span>-
ssh<span class="w"> </span>foo@example.org
<span class="c1"># enter yes</span>
</code></pre></div>

<h2 id="resizing-luks-encrypted-lvm"><a class="toclink" href="#resizing-luks-encrypted-lvm">Resizing LUKS encrypted LVM</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># expand the block device with fdisk, if necessary</span>

<span class="c1"># resize physical volume</span>
pvresize<span class="w"> </span>--setphysicalvolumesize<span class="w"> </span><span class="m">111</span>.8G<span class="w"> </span>/dev/sdb2
<span class="c1"># be careful about using `-l +100%FREE`.  this broke /home until I manually shrank fedora--vg-home by a few GB</span>
lvextend<span class="w"> </span>-l<span class="w"> </span>80G<span class="w"> </span>/dev/mapper/fedora--vg-home
resize2fs<span class="w"> </span>/dev/mapper/fedora--vg-home
</code></pre></div>

<h2 id="fixing-nodejs"><a class="toclink" href="#fixing-nodejs">Fixing Nodejs</a></h2>
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1125868">https://bugzilla.redhat.com/show_bug.cgi?id=1125868</a></p>
<h2 id="rsync"><a class="toclink" href="#rsync">Rsync</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># Sync permissions only. (useful if you forgot `-p` option in cp)</span>
<span class="c1"># Looks at filesize differences to determine if a copy is needed rather</span>
<span class="c1"># than timestamp (which gets reset when `-p` is left out of cp.</span>
rsync<span class="w"> </span>--archive<span class="w"> </span>--size-only<span class="w"> </span>/src/foo<span class="w"> </span>/dest/bar
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># -a : archive, preserve permissions, creation dates, etc</span>
<span class="c1"># -v : verbose</span>
<span class="c1"># -h : human readable file sizes</span>

rsync<span class="w"> </span>-avh<span class="w"> </span>src<span class="w"> </span>dest
</code></pre></div>

<h2 id="dns-tunneling-with-iodine"><a class="toclink" href="#dns-tunneling-with-iodine">DNS Tunneling with iodine</a></h2>
<p>Most of this was taken from <a href="http://dev.kryo.se/iodine/wiki/HowtoSetup">http://dev.kryo.se/iodine/wiki/HowtoSetup</a></p>
<h3 id="domain-setup"><a class="toclink" href="#domain-setup">Domain Setup</a></h3>
<p>On a domain you own (e.g. example.com), create an A record
server.example.com pointing to the ip of a server you own and an NS
record tunnel.example.com pointing to server.example.com.</p>
<p>To verify the setup is working, you can do:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># on the server</span>
sudo<span class="w"> </span>nc<span class="w"> </span>-u<span class="w"> </span>-l<span class="w"> </span>-p<span class="w"> </span><span class="m">53</span>

<span class="c1"># on another device</span>
dig<span class="w"> </span>+trace<span class="w"> </span>tunnel.example.com
<span class="c1"># you should see some stuff printed out in the console on the server</span>
</code></pre></div>

<h3 id="server-setup"><a class="toclink" href="#server-setup">Server Setup</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># set iptables rules</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
iptables<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span>-o<span class="w"> </span>dns0<span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>RELATED,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span>dns0<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># enable ip forwarding on the server</span>
<span class="c1">#  unnecessary if you want to use `ssh -D 1234` for dynamic port forwarding </span>
<span class="c1">#  on the client (as opposed to setting default routes)</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/net/ipv4/ip_forward

<span class="c1"># install iodine</span>
dnf<span class="w"> </span>install<span class="w"> </span>iodine

<span class="c1"># run iodine (as root in a screen session)</span>
<span class="c1">#  `password` is the password to use the tunnel</span>
<span class="c1">#  `192.168.99.1` is the ip of the server on the tunnel network</span>
iodined<span class="w"> </span>-c<span class="w"> </span>-P<span class="w"> </span>password<span class="w"> </span>-f<span class="w"> </span><span class="m">192</span>.168.99.1<span class="w"> </span>tunnel.example.com

<span class="c1"># note that if iodined is behind a NAT, you&#39;ll need to port forward UDP 53 and</span>
<span class="c1">#   use the `-p` option to tell iodined the server&#39;s external ip</span>
<span class="c1"># iodined -c -P password -f 192.168.99.1 tunnel.example.com -p [server.example.com ip]</span>
</code></pre></div>

<h3 id="client-setup"><a class="toclink" href="#client-setup">Client Setup</a></h3>
<p>Alternatively, you can download a script that does this part from
<a href="http://www.doeshosting.com/code/NStun.sh">http://www.doeshosting.com/code/NStun.sh</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># launch iodine client and wait for a &#39;Connection setup complete&#39; message</span>
sudo<span class="w"> </span>iodine<span class="w"> </span>-f<span class="w"> </span>tunnel.example.com

<span class="c1"># either use SSH for dynamic forwarding (one application at a time)  or set up routes</span>

<span class="c1"># ssh</span>
ssh<span class="w"> </span>-D<span class="w"> </span><span class="m">1234</span><span class="w"> </span>tunnel.example.com
<span class="c1"># set Firefox to use socks proxy localhost on port 1234</span>

<span class="c1"># set up routes</span>
<span class="c1"># get the current gateway ip</span>
ip<span class="w"> </span>route
<span class="c1"># get the tunnel server ip</span>
host<span class="w"> </span>server.example.com
<span class="c1"># add a route for iodine to communicate with the outside world</span>
sudo<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="o">[</span>server.example.com<span class="w"> </span>IP<span class="o">]</span><span class="w"> </span>via<span class="w"> </span><span class="o">[</span>current<span class="w"> </span>gateway<span class="w"> </span>IP<span class="o">]</span>
<span class="c1"># delete the default route for traffic</span>
sudo<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>delete<span class="w"> </span>default
<span class="c1"># add a default route so that all traffic is tunneled</span>
sudo<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.99.1
<span class="c1"># also DNS may not work, so you might have to manually set it to something reasonable</span>
sudo<span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;echo nameserver 8.8.4.4 &gt; /etc/resolv.conf&quot;</span>
</code></pre></div>

<h2 id="dns"><a class="toclink" href="#dns">DNS</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># lookup the hostname or domain name associated with ip address</span>
<span class="c1"># also works for local machines in the search domain</span>
dig<span class="w"> </span>-x<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div>

<h2 id="booting"><a class="toclink" href="#booting">Booting</a></h2>
<p><strong>block</strong> - smallest addressable unit of storage</p>
<div class="codehilite"><pre><span></span><code>Block size is defined in the hardware of a hard drive, but the OS can
define a virtual block size which chains multiple blocks together.
</code></pre></div>

<p>There are three primary boot options involving UEFI and BIOS firmwares</p>
<ul>
<li>UEFI-GPT<ul>
<li>required if dualbooting windows</li>
</ul>
</li>
<li>BIOS-GPT</li>
<li>BIOS-MBR<ul>
<li>max addressable disk space is 2^32 * 512 = 2 TiB on a system
    with 512 byte blocks.</li>
</ul>
</li>
</ul>
<h2 id="gpt-guid-partition-table"><a class="toclink" href="#gpt-guid-partition-table">GPT - GUID Partition Table</a></h2>
<p><strong>protective mbr</strong> - <code>a small partition at the beginning of the GPT disk
(where the MBR would normally be) that prevents older MBR tools from
damaging the GPT formatting</code></p>
<p>This partition contains a fake partition record which spans the entirety
of the disk. MBR programs will see that there is a partition of unknown
type that spans the entire disk and will refuse to operate.</p>
<p>A GPT disk is formatted like so:</p>
<table>
<tr><td>Protective MBR</td><td>512B</td></tr>
<tr><td>GPT Header</td><td>512B</td></tr>
<tr><td>GPT Partition Table</td><td>16KB</td></tr>
<tr><td><b>Partitions</b></td><td>XXX</td></tr>
<tr><td>Backup Partition Table</td><td>16KB</td></tr>
<tr><td>Backup Header</td><td>512B</td></tr>
</table>

<p>So there should be 17KB and 16.5KB of free space at the beginning and
end of a GPT disk.</p>
<h2 id="random-facts"><a class="toclink" href="#random-facts">Random facts</a></h2>
<ul>
<li>grub2-install invokes efibootmgr to install (aka register) entries
    in the nvram</li>
<li>these nvram entries point to .efi executables on the ESP</li>
<li>the harddrive UEFI menu entries are for legacy booting these devices</li>
<li>efi/boot/bootx64.efi is the .efi executable location for removable
    devices and doesn't require any nvram registration</li>
<li></li>
</ul>
<h2 id="smart-status"><a class="toclink" href="#smart-status">SMART Status</a></h2>
<div class="codehilite"><pre><span></span><code>smartctl -a /dev/sdX
smartctl -t short /dev/sdX
</code></pre></div>

<h2 id="network-interfaces-and-bridging"><a class="toclink" href="#network-interfaces-and-bridging">Network interfaces and bridging</a></h2>
<h3 id="simulating-network-disconnect"><a class="toclink" href="#simulating-network-disconnect">Simulating network disconnect</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># add network namespaces (for network isolation)</span>
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>client-ns
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>server-ns

<span class="c1"># create pairs of virtual interfaces</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>client<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>client-bridge
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>server<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>server-bridge
<span class="c1"># add virtual interfaces to namespace</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>client<span class="w"> </span>netns<span class="w"> </span>client-ns
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>server<span class="w"> </span>netns<span class="w"> </span>server-ns
<span class="c1"># give addresses to each virtual interface</span>
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>client-ns<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.0.2/24<span class="w"> </span>dev<span class="w"> </span>client
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>server-ns<span class="w"> </span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.0.1/24<span class="w"> </span>dev<span class="w"> </span>server
<span class="c1"># set virtual interfaces up</span>
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>client-ns<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>client<span class="w"> </span>up
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>server-ns<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>server<span class="w"> </span>up
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>client-bridge<span class="w"> </span>up
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>server-bridge<span class="w"> </span>up

<span class="c1"># add bridge interface</span>
sudo<span class="w"> </span>brctl<span class="w"> </span>addbr<span class="w"> </span>bridge0
<span class="c1"># link virtual interfaces to bridge</span>
sudo<span class="w"> </span>brctl<span class="w"> </span>add<span class="w"> </span><span class="k">if</span><span class="w"> </span>bridge0<span class="w"> </span>client-bridge
sudo<span class="w"> </span>brctl<span class="w"> </span>add<span class="w"> </span><span class="k">if</span><span class="w"> </span>bridge0<span class="w"> </span>server-bridge
<span class="c1"># set bridge up</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>bridge0<span class="w"> </span>up

<span class="c1"># (in a new terminal) do stuff on the virtual interface</span>
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>client-ns<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.0.0.1

<span class="c1"># set bridge down (simulate network offline)</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>bridge0<span class="w"> </span>down

<span class="c1"># sometimes you might need to use the loopback interface</span>
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>client-ns<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up
sudo<span class="w"> </span>ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>server-ns<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lo<span class="w"> </span>up
</code></pre></div>

<h2 id="ubuntu-vnc-server"><a class="toclink" href="#ubuntu-vnc-server">Ubuntu VNC Server</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># install x11vnc</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>x11vnc
<span class="c1"># create a password</span>
x11vnc<span class="w"> </span>-storepasswd
<span class="c1"># start the server</span>
</code></pre></div>

<p>To automatically run the server at login, add a startup script:</p>
<div class="codehilite"><pre><span></span><code>gnome-session-properties
</code></pre></div>

<p>Add a new item called "VNC" with the command field set to</p>
<div class="codehilite"><pre><span></span><code>x11-vnc<span class="w"> </span>-forever<span class="w"> </span>-loop<span class="w"> </span>-noxdamage<span class="w"> </span>-repeat<span class="w"> </span>-rfbport<span class="w"> </span><span class="m">5900</span><span class="w"> </span>-shared<span class="w"> </span>-usepw
</code></pre></div>

<p>Remember to set the machine to never suspend in the system power
settings.</p>
<h2 id="buildroot"><a class="toclink" href="#buildroot">Buildroot</a></h2>
<h3 id="useful-options"><a class="toclink" href="#useful-options">Useful options</a></h3>
<ul>
<li>toolchain &gt; enable wchar support</li>
<li>bootloaders &gt; grub2</li>
<li>toolchain &gt; C library</li>
<li>filesystem images &gt; iso image</li>
</ul>
<h2 id="fedora-copr"><a class="toclink" href="#fedora-copr">Fedora COPR</a></h2>
<p>List copr repos</p>
<div class="codehilite"><pre><span></span><code>dnf copr list
</code></pre></div>

<p>List copr repos</p>
<div class="codehilite"><pre><span></span><code>dnf copr list
</code></pre></div>

<p>List copr repos</p>
<div class="codehilite"><pre><span></span><code>dnf copr list
</code></pre></div>

<p>Removing copr repos</p>
<div class="codehilite"><pre><span></span><code>sudo dnf copr remove foo/bar
</code></pre></div>

<h2 id="broken-tty"><a class="toclink" href="#broken-tty">Broken TTY</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">DISPLAY</span><span class="o">=</span><span class="p">:</span><span class="mi">0</span><span class="w"> </span><span class="n">loadkeys</span><span class="w"> </span><span class="n">us</span>
</code></pre></div>

<h2 id="qemu"><a class="toclink" href="#qemu">QEMU</a></h2>
<div class="codehilite"><pre><span></span><code>qemu-system-x86_64 -cdrom image.iso -boot d -net nic -net user -m 256 -rtc base=localtime -icount 1,sleep=off -rtc clock=vm
</code></pre></div>

<h2 id="playing-sound"><a class="toclink" href="#playing-sound">Playing Sound</a></h2>
<p>The <code>beep</code> command requires that the <code>pcspkr</code> module be loaded.  An alternative is the <code>play</code> command (provided by the <code>sox</code> package which ships with some systems).</p>
<div class="codehilite"><pre><span></span><code>play -n -c1 synth sin 330 fade h 0.1 0.2 0.1 : synth sin 330 fade h 0.1 0.2 0.1
</code></pre></div>

<p>There are a variety of effects and waveforms that can be chained or played simultaneously.</p>
<h2 id="connecting-to-multiple-wifi-networks-simultaneously"><a class="toclink" href="#connecting-to-multiple-wifi-networks-simultaneously">Connecting to Multiple WiFi Networks Simultaneously</a></h2>
<p>Add a new dummy interface called <code>wlan0</code> that is tied to the real interface <code>wlp3s0</code></p>
<div class="codehilite"><pre><span></span><code><span class="nx">sudo</span><span class="w"> </span><span class="nx">iw</span><span class="w"> </span><span class="nx">dev</span><span class="w"> </span><span class="nx">wlp3s0</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">wlan0</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nx">station</span>
</code></pre></div>

<p>Then use NetworkManager as normal to connect to another network with this new interface.</p>
<h2 id="nmcli"><a class="toclink" href="#nmcli">NMCLI</a></h2>
<p>Connect to a specific BSSID</p>
<div class="codehilite"><pre><span></span><code><span class="nv">nmcli</span><span class="w"> </span><span class="nv">dev</span><span class="w"> </span><span class="nv">wifi</span><span class="w"> </span><span class="k">connect</span><span class="w"> </span><span class="s2">&quot;XX:XX:XX:XX:XX:XX&quot;</span>
</code></pre></div>

<p>List access points</p>
<div class="codehilite"><pre><span></span><code>nmcli dev wifi list
</code></pre></div>

<h2 id="flatpak-filesystem-access"><a class="toclink" href="#flatpak-filesystem-access">Flatpak Filesystem Access</a></h2>
<p>Give all flatpak programs access to the filesystem by default</p>
<div class="codehilite"><pre><span></span><code>flatpak --user override --filesystem=host
</code></pre></div>

<h2 id="syncthing-cli"><a class="toclink" href="#syncthing-cli">Syncthing CLI</a></h2>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> get current device ID
syncthing cli show system | grep myID
<span class="gh">#</span> add another device
syncthing cli config devices add --name OTHER_MACHINE --device-id OTHER_ID
<span class="gh">#</span> share a folder
syncthing cli config folders FOLDER_ID devices add --device-id OTHER_ID
</code></pre></div>

<h2 id="nmap"><a class="toclink" href="#nmap">NMAP</a></h2>
<p>Produce prettier NMAP output with custom XSL.  Append <code>--stylesheet [URL] -oX - | xsltproc -</code> to the end of the nmap command.</p>
<div class="codehilite"><pre><span></span><code># bad styling
sudo nmap -sS 192.168.1.100-200 -p 1234 
# cleaner styling
sudo nmap -sS 192.168.1.100-200 -p 1234 --stylesheet https://evan.widloski.com/notes/linux/nmap.xsl -oX - | xsltproc -
</code></pre></div>

<h2 id="annoying-people-with-mpv"><a class="toclink" href="#annoying-people-with-mpv">Annoying People with MPV</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">mpv</span><span class="w"> </span><span class="c1">--vo=tct --profile=low-latency --untimed /dev/video0 --vo-tct-width=40 | ssh root@copernicus.ece.illinois.edu -i ~/.ssh/id_rsa.pub &#39;cat &gt; /dev/pts/15&#39;</span>
</code></pre></div>
</article>

    </main>
<footer>
    <p>Evan Widloski - Rendered with <a href="https://github.com/evidlo/legoman">Legoman</a></p>
</footer>
</body>
</html>