<!DOCTYPE html>
<html lang=en>

<head>
    <title>Linux Notes</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="/styles.css" /> 
    <link rel="stylesheet" type="text/css" href="/codehilite.css" /> 
    <link rel="alternate" type="application/rss+xml" href="/rss.html" title="RSS feed">
</head>
<body>
    <main>
        <article>
        <header>
            <h1>Linux Notes</h1>
            <time datetime=""></time>
        </header>
        <div class="toc">
        <ul>
        <li><a href="#systemd">systemd</a><ul>
        <li><a href="#commands">Commands</a></li>
        <li><a href="#examples">Examples</a></li>
        </ul>
        </li>
        <li><a href="#basic-arch-install">Basic Arch Install</a></li>
        <li><a href="#generic-linux-install">Generic Linux Install</a></li>
        <li><a href="#udev">udev</a></li>
        <li><a href="#iptables">iptables</a><ul>
        <li><a href="#commands_1">Commands</a></li>
        <li><a href="#examples_1">Examples</a></li>
        </ul>
        </li>
        <li><a href="#lvm">LVM</a><ul>
        <li><a href="#adding">Adding</a></li>
        <li><a href="#deleting">Deleting</a></li>
        </ul>
        </li>
        <li><a href="#btrfs">BTRFS</a></li>
        <li><a href="#lxc">LXC</a><ul>
        <li><a href="#config-examples">Config examples</a></li>
        <li><a href="#commands_2">Commands</a></li>
        <li><a href="#new-container-setup">New Container Setup</a><ul>
        <li><a href="#debian">Debian</a></li>
        <li><a href="#fedora">Fedora</a></li>
        </ul>
        </li>
        </ul>
        </li>
        <li><a href="#weechat">Weechat</a></li>
        <li><a href="#mdadm">MDADM</a><ul>
        <li><a href="#checking-state-and-simulating-failure">Checking state and simulating failure</a></li>
        <li><a href="#replacing-a-failed-drive-sdc">Replacing a failed drive (sdc)</a></li>
        <li><a href="#notifying-on-harddrive-failure-gmail">Notifying on harddrive failure (gmail)</a></li>
        <li><a href="#growing-raid-size">Growing RAID size</a></li>
        <li><a href="#accessing-via-live-cd">Accessing via Live CD</a></li>
        <li><a href="#installing-grub-on-a-live-cd-mounted-system">Installing GRUB on a Live CD Mounted System</a></li>
        </ul>
        </li>
        <li><a href="#mounting-images">Mounting Images</a></li>
        <li><a href="#auto-fs">Auto FS</a></li>
        <li><a href="#resizing-luks-encrypted-lvm">Resizing LUKS encrypted LVM</a></li>
        <li><a href="#fixing-nodejs">Fixing Nodejs</a></li>
        <li><a href="#rsync">Rsync</a></li>
        <li><a href="#dns-tunneling-with-iodine">DNS Tunneling with iodine</a><ul>
        <li><a href="#domain-setup">Domain Setup</a></li>
        <li><a href="#server-setup">Server Setup</a></li>
        <li><a href="#client-setup">Client Setup</a></li>
        </ul>
        </li>
        <li><a href="#rdns">rDNS</a></li>
        <li><a href="#booting">Booting</a><ul>
        <li><a href="#gpt-guid-partition-table">GPT - GUID Partition Table</a></li>
        <li><a href="#random-facts">Random facts</a></li>
        </ul>
        </li>
        <li><a href="#smart-status">SMART Status</a></li>
        <li><a href="#network-interfaces-and-bridging">Network interfaces and bridging</a><ul>
        <li><a href="#simulating-network-disconnect">Simulating network disconnect</a></li>
        </ul>
        </li>
        <li><a href="#ubuntu-vnc-server">Ubuntu VNC Server</a></li>
        <li><a href="#buildroot">Buildroot</a><ul>
        <li><a href="#useful-options">Useful options</a></li>
        </ul>
        </li>
        </ul>
        </div>
        <h1 id="systemd">systemd</h1>
        <p><strong>/etc/systemd/system</strong> - default location for system units
        <strong>\~/.config/systemd/user</strong> - default location for user units</p>
        <h2 id="commands">Commands</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># reload units and timers</span>
        systemctl <span class="o">[</span>--user<span class="o">]</span> daemon-reload
        <span class="c1"># show all units (including disabled)</span>
        systemctl <span class="o">[</span>--user<span class="o">]</span> list-units -a
        <span class="c1"># view logs for unit</span>
        <span class="c1"># also accepts:</span>
        <span class="c1">#   -f               | tail the log</span>
        <span class="c1">#   --user-unit foo  | target user unit instead of system</span>
        <span class="c1">#   --boot=0         | show logs from current boot (-1 for previous, etc)</span>
        journalctl --unit foo
        </pre></div>


        <h2 id="examples">Examples</h2>
        <p>A simple service unit</p>
        <p><strong>foobar.service</strong></p>
        <div class="codehilite"><pre><span></span>[Unit]
        Description=example service

        [Service]
        WorkingDirectory=/path/to/dir
        Environment=&quot;FOOBAR=foo&quot;
        ExecStart=foobar.sh

        [Install]
        WantedBy=multi-user.target
        </pre></div>


        <p><strong>foobar.timer</strong> A simple timer unit</p>
        <div class="codehilite"><pre><span></span>[Unit]
        Description=example timer

        [Timer]
        # run every 15 minutes (aligns to the hour)
        OnCalendar=*:0/15
        # run timer immediately if script is enabled and is past due
        Persistent=true

        [Install]
        WantedBy=timers.target
        </pre></div>


        <h1 id="basic-arch-install">Basic Arch Install</h1>
        <div class="codehilite"><pre><span></span>dhcpcd

        timedatectl set-ntp <span class="nb">true</span>


        fdisk /dev/sda 

        <span class="c1"># Create 300MB boot, 2GB swap, and leave the rest for root</span>

        mkswp /dev/sda2

        mkfs.ext4 /dev/sda3

        mount /dev/sda3 /mnt

        swapon /dev/sda2

        <span class="c1"># edit /etc/pacman.d/mirrorlist to change mirror order **</span>

        pacstrap /mnt base

        genfstab -p /mnt &gt;&gt; /mnt/etc/fstab

        arch-chroot /mnt

        ln -s /usr/share/zoneinfo/America/Indianapolis /etc/localtime

        hwclock --systohc --utc

        <span class="c1"># uncomment en_US locales in /etc/locale.gen **</span>

        locale-gen

        <span class="c1"># enter hostname in /etc/hostname **</span>

        mkinitcpio -p linux

        passwd

        pacman -S grub

        grub-install --target<span class="o">=</span>i386-pc --recheck --debug /dev/sda

        grub-mkconfig -o /boot/grub/grub.cfg

        <span class="nb">exit</span>

        reboot

        pacman -S vim htop git openssh wget

        pacman -S xorg-server xf86-video-ati xorg-xinit
        </pre></div>


        <h1 id="generic-linux-install">Generic Linux Install</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># list all available block devices</span>
        lsblk
        <span class="c1"># Copy bootable image to flash drive (status=progress requires dd &gt;= 8.24)</span>
        <span class="c1"># be careful not to mess up the of= argument, or you might overwrite your HD</span>
        sudo dd <span class="k">if</span><span class="o">=</span>foobar.iso <span class="nv">of</span><span class="o">=</span>/dev/sdX <span class="nv">status</span><span class="o">=</span>progress <span class="o">&amp;&amp;</span> sync
        </pre></div>


        <h1 id="udev">udev</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># show device connect/disconnects and fired rules</span>
        udevadm monitor
        <span class="c1"># list all attributes for a particular device (and parents)</span>
        udevadm info --attribute-walk --path<span class="o">=</span>/devices/...
        </pre></div>


        <div class="codehilite"><pre><span></span><span class="c1"># simple vendorid, productid example</span>
        <span class="c1"># note SYMLINK is only for block devices (I think, look it up yourself)</span>
        <span class="nv">SUBSYSTEMS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">&quot;3300&quot;</span>, ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">&quot;1e10&quot;</span>, <span class="nv">MODE</span><span class="o">=</span><span class="s2">&quot;0666&quot;</span>, <span class="nv">SYMLINK</span><span class="o">+=</span><span class="s2">&quot;foobar&quot;</span>
        </pre></div>


        <h1 id="iptables">iptables</h1>
        <h2 id="commands_1">Commands</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># list all tables</span>
        iptables -L -n -v
        <span class="c1"># (fedora) save iptables rules and remember to disable firewalld</span>
        iptables-save &gt; /etc/sysconfig/iptables
        </pre></div>


        <h2 id="examples_1">Examples</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># allow ssh</span>
        <span class="c1"># must allow incoming connection and response</span>

        <span class="c1"># append rule to input (-A INPUT) on input interface enp6s0f0 (-i enp6s0f0) </span>
        <span class="c1"># with destination port 22 (--dport 22).  use &#39;state&#39; module (-m state)</span>
        <span class="c1"># and allow new and established connections (--state NEW,ESTABLISHED)</span>
        <span class="c1"># jump to target ACCEPT (-j ACCEPT)</span>
        iptables -A INPUT -i enp6s0f0 -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT

        <span class="c1"># append rule to output (-A OUTPUT) on output interface enp6s0f0 (-o enp6s0f0) </span>
        <span class="c1"># with source port 22 (--sport 22).  use &#39;state&#39; module (-m state)</span>
        <span class="c1"># and allow established connections (--state ESTABLISHED)</span>
        <span class="c1"># jump to target ACCEPT (-j ACCEPT)</span>
        iptables -A OUTPUT -o enp6s0f0 -p tcp --sport <span class="m">22</span> -m state --state ESTABLISHED -j ACCEPT
        </pre></div>


        <div class="codehilite"><pre><span></span><span class="c1"># filter table: flush all chains, and delete all user added chains</span>
        iptables -F
        iptables -X
        <span class="c1"># nat table: flush all chains, and delete all user added chains</span>
        iptables -t nat -F
        iptables -t nat -X
        </pre></div>


        <h1 id="lvm">LVM</h1>
        <h2 id="adding">Adding</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># create new lv `foo` in group `foo_group`</span>
        lvcreate -L 10G foo_group -n foo
        </pre></div>


        <h2 id="deleting">Deleting</h2>
        <div class="codehilite"><pre><span></span>lvremove /dev/<span class="o">[</span>vgname<span class="o">]</span>/<span class="o">[</span>lvname<span class="o">]</span>
        </pre></div>


        <h1 id="btrfs">BTRFS</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># add all devices to filesystem</span>
        btrfs device add /dev/sdb2 /dev/sdc2 /dev/sdd2 /
        <span class="c1"># convert system to raid10</span>
        btrfs balance start -dconvert<span class="o">=</span>raid10 -mconvert<span class="o">=</span>raid10 /
        <span class="c1"># check balance progress</span>
        btrfs balance status /
        <span class="c1"># get rid of single chunks to get another shot at degraded,rw mount</span>
        btrfs balance start -dconvert<span class="o">=</span>raid10,soft -mconvert<span class="o">=</span>raid10,soft  /mount
        </pre></div>


        <h1 id="lxc">LXC</h1>
        <p><a href="https://www.flockport.com/enable-lxc-networking-in-debian-jessie-fedora-and-others/">https://www.flockport.com/enable-lxc-networking-in-debian-jessie-fedora-and-others/</a></p>
        <h2 id="config-examples">Config examples</h2>
        <p><strong>/etc/lxc/lxc.conf</strong> - set path for containers to be stored (default
        /var/lib/lxc)</p>
        <div class="codehilite"><pre><span></span>lxc.lxcpath <span class="o">=</span> <span class="s2">&quot;/lxc&quot;</span>
        </pre></div>


        <p><strong>/etc/lxc/default.conf</strong> - config options for all newly created
        containers to inherit</p>
        <div class="codehilite"><pre><span></span>lxc.network.type <span class="o">=</span> veth
        lxc.network.link <span class="o">=</span> lxcbr0
        lxc.network.flags <span class="o">=</span> up
        lxc.network.hwaddr <span class="o">=</span> <span class="m">00</span>:16:3e:xx:xx:xx
        lxc.start.auto <span class="o">=</span> <span class="m">1</span>

        <span class="c1"># address</span>
        <span class="c1">#lxc.network.ipv4 = 192.168.1.1xx</span>
        lxc.network.ipv4.gateway <span class="o">=</span> <span class="m">192</span>.168.1.1

        <span class="c1"># memory</span>
        lxc.cgroup.memory.limit_in_bytes <span class="o">=</span> 512M

        <span class="c1"># memory + swap</span>
        lxc.cgroup.memory.memsw.limit_in_bytes <span class="o">=</span> 1G
        </pre></div>


        <p><strong>/etc/default/lxc-net</strong> - it may be necessary to add
        /etc/lxc/dnsasq.conf to the apparmor profile
        (/etc/apparmor.d/*dnsmasq*) with read privileges</p>
        <div class="codehilite"><pre><span></span><span class="nv">USE_LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
        <span class="nv">LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;lxcbr0&quot;</span>
        <span class="nv">LXC_ADDR</span><span class="o">=</span><span class="s2">&quot;192.168.1.1&quot;</span>
        <span class="nv">LXC_NETMASK</span><span class="o">=</span><span class="s2">&quot;255.255.255.0&quot;</span>
        <span class="nv">LXC_NETWORK</span><span class="o">=</span><span class="s2">&quot;192.168.1.0/24&quot;</span>
        <span class="nv">LXC_DHCP_RANGE</span><span class="o">=</span><span class="s2">&quot;192.168.1.100,192.168.1.199&quot;</span>
        <span class="nv">LXC_DHCP_MAX</span><span class="o">=</span><span class="s2">&quot;100&quot;</span>
        <span class="nv">LXC_DHCP_CONFILE</span><span class="o">=</span><span class="s2">&quot;/etc/lxc/dnsmasq.conf&quot;</span>
        <span class="nv">LXC_DOMAIN</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        </pre></div>


        <p><strong>/etc/lxc/dnsmasq.conf</strong></p>
        <div class="codehilite"><pre><span></span>dhcp-host<span class="o">=</span>evan,192.168.1.102
        </pre></div>


        <p><strong>iptables config</strong></p>
        <div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>
        <span class="c1">## Evan Widloski - 2016-11-11</span>
        <span class="c1"># Diode iptables rules</span>

        <span class="c1"># filter table: flush all chains, and delete all user added chains</span>
        iptables -F
        iptables -X
        <span class="c1"># nat table: flush all chains, and delete all user added chains</span>
        iptables -t nat -F
        iptables -t nat -X

        <span class="c1"># set default policies to DROP packets</span>
        iptables -P INPUT DROP
        iptables -P OUTPUT DROP
        iptables -P FORWARD DROP

        <span class="c1"># allow inbound outbound traffic on host </span>
        iptables -A OUTPUT -o enp6s0f0 -d <span class="m">0</span>.0.0.0/0 -j ACCEPT 
        iptables -A INPUT -i enp6s0f0 -m state --state ESTABLISHED,RELATED -j ACCEPT

        <span class="c1"># set up chain for sshguard</span>
        iptables -N sshguard
        iptables -A INPUT -p tcp --dport <span class="m">22</span> -j sshguard

        <span class="c1"># allow ssh</span>
        iptables -A INPUT -i enp6s0f0 -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT
        iptables -A OUTPUT -o enp6s0f0 -p tcp --sport <span class="m">22</span> -m state --state ESTABLISHED -j ACCEPT

        <span class="c1"># allow mosh</span>
        iptables -A INPUT -i enp6s0f0 -p udp --dport <span class="m">60000</span>:61000 -j ACCEPT
        iptables -A OUTPUT -o enp6s0f0 -p udp --sport <span class="m">60000</span>:61000 -j ACCEPT

        <span class="c1"># allow connections to varnish service</span>
        <span class="c1">#iptables -A INPUT -i enp6s0f0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span>
        <span class="c1">#iptables -A OUTPUT -o enp6s0f0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT</span>

        <span class="c1"># allow host to access LXC targets via network</span>
        iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
        iptables -A OUTPUT -s <span class="m">192</span>.168.1.0/24 -j ACCEPT

        <span class="c1"># allow outbound traffic for lxc containers</span>
        iptables -A FORWARD -i lxcbr0 -j ACCEPT
        iptables -t nat -A POSTROUTING -s <span class="m">192</span>.168.1.0/24 -j MASQUERADE

        <span class="c1"># after incoming packets have been NAT&#39;ed (see below), allow them to pass through</span>
        <span class="c1"># the forward chain to their intended LXC target</span>
        iptables -A FORWARD -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT

        <span class="c1">##------------ evan --------------</span>
        <span class="c1">## ssh</span>
        iptables -t nat -A PREROUTING -p tcp --dport <span class="m">20022</span> -j DNAT --to-destination <span class="m">192</span>.168.1.102:22
        </pre></div>


        <h2 id="commands_2">Commands</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># list container statuses and ip addresses (fancy mode)</span>
        lxc-ls -f
        </pre></div>


        <div class="codehilite"><pre><span></span>brctl show
        brctl delbr virbr0
        brctl addbr virbr0
        ip link <span class="nb">set</span> virbr0 down
        </pre></div>


        <h2 id="new-container-setup">New Container Setup</h2>
        <p>New LXC containers are very barebones and need a bit of setup to be
        useful. Here is an overview of steps for various distros.</p>
        <h3 id="debian">Debian</h3>
        <p>Setup PATH</p>
        <div class="codehilite"><pre><span></span><span class="c1"># add /bin, /sbin to path</span>
        <span class="nb">echo</span> <span class="s1">&#39;PATH=$PATH:/bin:/sbin&#39;</span>&gt;&gt;.bashrc
        </pre></div>


        <p>Install packages</p>
        <div class="codehilite"><pre><span></span><span class="c1"># core commands</span>
        apt-get install apt-utils vim man tar less iputils-ping

        <span class="c1"># extra commands</span>
        apt-get install git zip autojump wget htop ncdu nload
        </pre></div>


        <h3 id="fedora">Fedora</h3>
        <p>Install packages</p>
        <div class="codehilite"><pre><span></span><span class="c1"># core commands</span>
        dnf install vim man

        <span class="c1"># core commands</span>
        dnf install git zip autojump wget htop ncdu nload
        </pre></div>


        <h1 id="weechat">Weechat</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># enable notifications for any messages in buffer (works for Android client, too)</span>
        /buffer <span class="nb">set</span> highlight_regex .<span class="se">\a</span>st<span class="o">{}</span>.*
        </pre></div>


        <h1 id="mdadm">MDADM</h1>
        <h2 id="checking-state-and-simulating-failure">Checking state and simulating failure</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># check RAID state</span>
        cat /proc/mdstat  <span class="c1"># look for failure, (F), after the drive name: sda1[0](F)</span>

        <span class="c1"># simulate a failed drive</span>
        mdadm --manage --set-faulty /dev/md/pv00 /dev/sda1

        <span class="c1"># remove faulty state by removing and readding</span>
        mdadm --remove /dev/md/pv00 /dev/sda1
        mdadm --add /dev/md/pv00 /dev/sda1
        </pre></div>


        <h2 id="replacing-a-failed-drive-sdc">Replacing a failed drive (sdc)</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># set hard drive as failed</span>
        <span class="c1"># mark as failed and remove</span>
        mdadm --manage /dev/md127 --fail /dev/sdc1
        mdadm --manage /dev/md127 --remove /dev/sdc1

        <span class="c1"># write down serial number of failed drive</span>
        hdparm -i /dev/sdc1 <span class="p">|</span> grep -i serial
        shutdown -h now
        <span class="c1"># remove broken harddrive, insert the new hardddrive</span>

        <span class="c1"># copy partition scheme from working harddrive to new harddrive</span>
        sfdisk -d /dev/sda <span class="p">|</span> sfdisk /dev/sdc

        <span class="c1"># add new harddrive</span>
        mdadm --manage /dev/md127 --add /dev/sdc1

        <span class="c1"># verify that array is recovering</span>
        cat /proc/mdstat
        </pre></div>


        <h2 id="notifying-on-harddrive-failure-gmail">Notifying on harddrive failure (gmail)</h2>
        <p><strong>/etc/exim/exim.conf</strong></p>
        <div class="codehilite"><pre><span></span><span class="c1"># add this after `begin routers` in router config section</span>
         <span class="n">send_via_gmail</span><span class="p">:</span>
             <span class="n">driver</span> <span class="o">=</span> <span class="n">manualroute</span>
             <span class="n">domains</span> <span class="o">=</span> <span class="err">!</span> <span class="o">+</span><span class="n">local_domains</span>
             <span class="n">transport</span> <span class="o">=</span> <span class="n">gmail_smtp</span>
             <span class="n">route_list</span> <span class="o">=</span> <span class="o">*</span> <span class="n">gmail</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
        <span class="c1"># add this after `begin transports` in transports config section</span>
         <span class="n">gmail_smtp</span><span class="p">:</span>
             <span class="n">driver</span> <span class="o">=</span> <span class="n">smtp</span>
             <span class="n">port</span> <span class="o">=</span> <span class="mi">587</span>
             <span class="n">hosts_require_auth</span> <span class="o">=</span> <span class="n">gmail</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
             <span class="n">hosts_require_tls</span> <span class="o">=</span> <span class="n">gmail</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
        <span class="c1"># add this after `begin authenaticators` in authentication config section</span>
         <span class="n">gmail_login</span><span class="p">:</span>
             <span class="n">driver</span> <span class="o">=</span> <span class="n">plaintext</span>
             <span class="n">public_name</span> <span class="o">=</span> <span class="n">LOGIN</span>
             <span class="n">client_send</span> <span class="o">=</span> <span class="p">:</span> <span class="n">sender_email</span><span class="nd">@gmail.com</span> <span class="p">:</span> <span class="n">password_in_plaintext_here</span>
        </pre></div>


        <p><strong>/etc/mdadm.conf</strong></p>
        <div class="codehilite"><pre><span></span>MAILADDR destination_email@example.com
        AUTO +imsm +1.x -all
        ARRAY /dev/md/pv00 level=raid5 num-devices=4 UUID=1327a02b:b19f6696:0e3f8ac7:9615591c
        </pre></div>


        <h2 id="growing-raid-size">Growing RAID size</h2>
        <p>This is useful if the RAID array needs to be grown by using up more free
        space (no added harddrive)</p>
        <div class="codehilite"><pre><span></span>umount /dev/sda
        umount /dev/sdb
        umount /dev/sdc
        umount /dev/sdd

        <span class="c1"># grow RAID array to 500GB (this will take a while)</span>
        mdadm -G /dev/md127 -z 500G

        <span class="c1"># resize physical volume to fit new RAID partition size</span>
        pvresize /dev/md127
        </pre></div>


        <h2 id="accessing-via-live-cd">Accessing via Live CD</h2>
        <p>If the array gets screwed up somehow, you can try mounting it on a
        livecd.</p>
        <div class="codehilite"><pre><span></span>apt install mdadm

        <span class="c1"># assemble array from block devices</span>
        mdadm --assemble --scan

        <span class="c1"># mount array (assuming lvm)</span>
        apt install lvm2

        <span class="c1"># see if lv&#39;s are intact</span>
        lvscan

        <span class="c1"># mount lv</span>
        mount /dev/<span class="o">[</span>vgname<span class="o">]</span>/<span class="o">[</span>lvname<span class="o">]</span> /mnt/foo
        </pre></div>


        <h2 id="installing-grub-on-a-live-cd-mounted-system">Installing GRUB on a Live CD Mounted System</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># mount root lv</span>
        mount /dev/<span class="o">[</span>vgname<span class="o">]</span>/root /mnt/root

        <span class="c1"># mount live CD directories inside mounted lv</span>
        <span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> sudo mount -B <span class="nv">$i</span> /mnt/root<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>

        <span class="c1"># chroot into root lv</span>
        chroot /mnt/root

        <span class="c1"># install grub to each device in array</span>
        grub2-install /dev/sda
        grub2-install /dev/sdb
        grub2-install /dev/sdc
        grub2-install /dev/sdd

        <span class="c1"># update grub config</span>
        grub2-mkconfig -o /boot/grub2/grub.cfg
        </pre></div>


        <h1 id="mounting-images">Mounting Images</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># list the partitions on the image file</span>
        fdisk -l /tmp/sdcard.img 
        </pre></div>


        <div class="codehilite"><pre><span></span><span class="nv">Disk</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">sdcard</span>.<span class="nv">img</span>: <span class="mi">162</span> <span class="nv">MiB</span>, <span class="mi">169869824</span> <span class="nv">bytes</span>, <span class="mi">331777</span> <span class="nv">sectors</span>
        <span class="nv">Units</span>: <span class="nv">sectors</span> <span class="nv">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nv">bytes</span>
        <span class="nv">Sector</span> <span class="nv">size</span> <span class="ss">(</span><span class="nv">logical</span><span class="o">/</span><span class="nv">physical</span><span class="ss">)</span>: <span class="mi">512</span> <span class="nv">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nv">bytes</span>
        <span class="nv">I</span><span class="o">/</span><span class="nv">O</span> <span class="nv">size</span> <span class="ss">(</span><span class="nv">minimum</span><span class="o">/</span><span class="nv">optimal</span><span class="ss">)</span>: <span class="mi">512</span> <span class="nv">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nv">bytes</span>
        <span class="nv">Disklabel</span> <span class="nv">type</span>: <span class="nv">dos</span>
        <span class="nv">Disk</span> <span class="nv">identifier</span>: <span class="mi">0</span><span class="nv">x00000000</span>

        <span class="nv">Device</span>           <span class="nv">Boot</span> <span class="nv">Start</span>    <span class="k">End</span> <span class="nv">Sectors</span>  <span class="nv">Size</span> <span class="nv">Id</span> <span class="nv">Type</span>
        <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">sdcard</span>.<span class="nv">img1</span> <span class="o">*</span>        <span class="mi">1</span>  <span class="mi">65536</span>   <span class="mi">65536</span>   <span class="mi">32</span><span class="nv">M</span>  <span class="nv">c</span> <span class="nv">W95</span> <span class="nv">FAT32</span> <span class="ss">(</span><span class="nv">LBA</span><span class="ss">)</span>
        <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">sdcard</span>.<span class="nv">img2</span>      <span class="mi">65537</span> <span class="mi">331776</span>  <span class="mi">266240</span>  <span class="mi">130</span><span class="nv">M</span> <span class="mi">83</span> <span class="nv">Linux</span>
        </pre></div>


        <div class="codehilite"><pre><span></span><span class="c1"># use the sector size and the partition start sector to calculate offset (512 * 65537)</span>
        sudo mount -o loop,offset<span class="o">=</span><span class="m">33554944</span> /tmp/sdcard.img /mnt/tmp
        </pre></div>


        <h1 id="auto-fs">Auto FS</h1>
        <p>Auto FS + SSHFS allows the system to mount ssh filesystems on access and
        then automatically unmount after a certain timeout. The necessary tools
        are <strong>autofs</strong> and <strong>sshfs</strong>.</p>
        <p><strong>/etc/auto.master</strong> or <strong>/etc/auto.master.d/foobar.autofs</strong> or
        <strong>/etc/autofs/auto.master</strong></p>
        <div class="codehilite"><pre><span></span><span class="c1"># mounts all the entries listed in /etc/auto.sshfs in /mnt/ with the given options</span>
        <span class="c1"># add the --verbose option here to debug mounting issues</span>
        <span class="c1"># set --timeout to control when sshfs mount is automatically unmounted</span>
        /mnt /etc/auto.sshfs --timeout<span class="o">=</span><span class="m">180</span> --ghost
        </pre></div>


        <p><strong>/etc/auto.sshfs</strong></p>
        <div class="codehilite"><pre><span></span><span class="c1"># make a mount to be used by auto.master</span>
        foobar -fstype<span class="o">=</span>fuse,rw,IdentityFile<span class="o">=</span>/home/evan/.ssh/foobar,port<span class="o">=</span><span class="m">22</span>,allow_other :sshfs<span class="se">\#</span>foo@example.org<span class="se">\:</span>
        </pre></div>


        <p>AutoFS runs as root, so ensure that the host fingerprint has been added
        to <strong><em>root</em>.ssh/known_hosts</strong>. You can add this easily by attempting to
        ssh login to foo\@example.org from root.</p>
        <div class="codehilite"><pre><span></span>su -
        ssh foo@example.org
        <span class="c1"># enter yes</span>
        </pre></div>


        <h1 id="resizing-luks-encrypted-lvm">Resizing LUKS encrypted LVM</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># expand the block device with fdisk, if necessary</span>

        <span class="c1"># resize physical volume</span>
        pvresize --setphysicalvolumesize <span class="m">111</span>.8G /dev/sdb2
        <span class="c1"># be careful about using `-l +100%FREE`.  this broke /home until I manually shrank fedora--vg-home by a few GB</span>
        lvextend -l 80G /dev/mapper/fedora--vg-home
        resize2fs /dev/mapper/fedora--vg-home
        </pre></div>


        <h1 id="fixing-nodejs">Fixing Nodejs</h1>
        <p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1125868">https://bugzilla.redhat.com/show_bug.cgi?id=1125868</a></p>
        <h1 id="rsync">Rsync</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># Sync permissions only. (useful if you forgot `-p` option in cp)</span>
        <span class="c1"># Looks at filesize differences to determine if a copy is needed rather</span>
        <span class="c1"># than timestamp (which gets reset when `-p` is left out of cp.</span>
        rsync --archive --size-only /src/foo /dest/bar
        </pre></div>


        <h1 id="dns-tunneling-with-iodine">DNS Tunneling with iodine</h1>
        <p>Most of this was taken from <a href="http://dev.kryo.se/iodine/wiki/HowtoSetup">http://dev.kryo.se/iodine/wiki/HowtoSetup</a></p>
        <h2 id="domain-setup">Domain Setup</h2>
        <p>On a domain you own (e.g. example.com), create an A record
        server.example.com pointing to the ip of a server you own and an NS
        record tunnel.example.com pointing to server.example.com.</p>
        <p>To verify the setup is working, you can do:</p>
        <div class="codehilite"><pre><span></span><span class="c1"># on the server</span>
        sudo nc -u -l -p <span class="m">53</span>

        <span class="c1"># on another device</span>
        dig +trace tunnel.example.com
        <span class="c1"># you should see some stuff printed out in the console on the server</span>
        </pre></div>


        <h2 id="server-setup">Server Setup</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># set iptables rules</span>
        iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        iptables -A FORWARD -i eth0 -o dns0 -m state --state RELATED,ESTABLISHED -j ACCEPT
        iptables -A FORWARD -i dns0 -o eth0 -j ACCEPT

        <span class="c1"># enable ip forwarding on the server</span>
        <span class="c1">#  unnecessary if you want to use `ssh -D 1234` for dynamic port forwarding </span>
        <span class="c1">#  on the client (as opposed to setting default routes)</span>
        <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward

        <span class="c1"># install iodine</span>
        dnf install iodine

        <span class="c1"># run iodine (as root in a screen session)</span>
        <span class="c1">#  `password` is the password to use the tunnel</span>
        <span class="c1">#  `192.168.99.1` is the ip of the server on the tunnel network</span>
        iodined -c -P password -f <span class="m">192</span>.168.99.1 tunnel.example.com

        <span class="c1"># note that if iodined is behind a NAT, you&#39;ll need to port forward UDP 53 and</span>
        <span class="c1">#   use the `-p` option to tell iodined the server&#39;s external ip</span>
        <span class="c1"># iodined -c -P password -f 192.168.99.1 tunnel.example.com -p [server.example.com ip]</span>
        </pre></div>


        <h2 id="client-setup">Client Setup</h2>
        <p>Alternatively, you can download a script that does this part from
        <a href="http://www.doeshosting.com/code/NStun.sh">http://www.doeshosting.com/code/NStun.sh</a>.</p>
        <div class="codehilite"><pre><span></span><span class="c1"># launch iodine client and wait for a &#39;Connection setup complete&#39; message</span>
        sudo iodine -f tunnel.example.com

        <span class="c1"># either use SSH for dynamic forwarding (one application at a time)  or set up routes</span>

        <span class="c1"># ssh</span>
        ssh -D <span class="m">1234</span> tunnel.example.com
        <span class="c1"># set Firefox to use socks proxy localhost on port 1234</span>

        <span class="c1"># set up routes</span>
        <span class="c1"># get the current gateway ip</span>
        ip route
        <span class="c1"># get the tunnel server ip</span>
        host server.example.com
        <span class="c1"># add a route for iodine to communicate with the outside world</span>
        sudo ip route add <span class="o">[</span>server.example.com IP<span class="o">]</span> via <span class="o">[</span>current gateway IP<span class="o">]</span>
        <span class="c1"># delete the default route for traffic</span>
        sudo ip route delete default
        <span class="c1"># add a default route so that all traffic is tunneled</span>
        sudo ip route add default via <span class="m">192</span>.168.99.1
        <span class="c1"># also DNS may not work, so you might have to manually set it to something reasonable</span>
        sudo sh -c <span class="s2">&quot;echo nameserver 8.8.4.4 &gt; /etc/resolv.conf&quot;</span>
        </pre></div>


        <h1 id="rdns">rDNS</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># lookup the hostname or domain name associated with ip address</span>
        <span class="c1"># also works for local machines in the search domain</span>
        dig -x <span class="m">1</span>.2.3.4
        </pre></div>


        <h1 id="booting">Booting</h1>
        <p><strong>block</strong> - smallest addressable unit of storage</p>
        <div class="codehilite"><pre><span></span><span class="n">Block</span> <span class="k">size</span> <span class="k">is</span> <span class="k">defined</span> <span class="k">in</span> <span class="n">the</span> <span class="n">hardware</span> <span class="k">of</span> <span class="n">a</span> <span class="n">hard</span> <span class="n">drive</span><span class="p">,</span> <span class="n">but</span> <span class="n">the</span> <span class="n">OS</span> <span class="n">can</span>
        <span class="n">define</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">block</span> <span class="k">size</span> <span class="n">which</span> <span class="n">chains</span> <span class="n">multiple</span> <span class="n">blocks</span> <span class="n">together</span><span class="p">.</span>
        </pre></div>


        <p>There are three primary boot options involving UEFI and BIOS firmwares</p>
        <ul>
        <li>UEFI-GPT<ul>
        <li>required if dualbooting windows</li>
        </ul>
        </li>
        <li>BIOS-GPT</li>
        <li>BIOS-MBR<ul>
        <li>max addressable disk space is 2\^32 * 512 = 2 TiB on a system
            with 512 byte blocks.</li>
        </ul>
        </li>
        </ul>
        <h2 id="gpt-guid-partition-table">GPT - GUID Partition Table</h2>
        <p><strong>protective mbr</strong> - <code>a small partition at the beginning of the GPT disk
        (where the MBR would normally be) that prevents older MBR tools from
        damaging the GPT formatting</code></p>
        <p>This partition contains a fake partition record which spans the entirety
        of the disk. MBR programs will see that there is a partition of unknown
        type that spans the entire disk and will refuse to operate.</p>
        <p>A GPT disk is formatted like so:</p>
        <table>
        <tr><td>Protective MBR</td><td>512B</td></tr>
        </table>

        <p>|------------------------|------|
        | Protect MBR            | 512B |
        | GPT Header             | 512B |
        | GPT Partition TAble    | 16KB |
        | <em>Partitions</em>           | XXX  |
        | Backup Partition Table | 16KB |
        | Backup Header          | 512B |
        |------------------------+------|</p>
        <p>So there should be 17KB and 16.5KB of free space at the beginning and
        end of a GPT disk.</p>
        <h2 id="random-facts">Random facts</h2>
        <ul>
        <li>grub2-install invokes efibootmgr to install (aka register) entries
            in the nvram</li>
        <li>these nvram entries point to .efi executables on the ESP</li>
        <li>the harddrive UEFI menu entries are for legacy booting these devices</li>
        <li>efi/boot/bootx64.efi is the .efi executable location for removable
            devices and doesn\'t require any nvram registration</li>
        <li></li>
        </ul>
        <h1 id="smart-status">SMART Status</h1>
        <p>::: {.definitions}
        smartctl -a /dev/sdX</p>
        <p>smartctl -t short /dev/sdX
        :::</p>
        <h1 id="network-interfaces-and-bridging">Network interfaces and bridging</h1>
        <h2 id="simulating-network-disconnect">Simulating network disconnect</h2>
        <div class="codehilite"><pre><span></span><span class="c1"># add network namespaces (for network isolation)</span>
        sudo ip netns add client-ns
        sudo ip netns add server-ns

        <span class="c1"># create pairs of virtual interfaces</span>
        sudo ip link add client <span class="nb">type</span> veth peer name client-bridge
        sudo ip link add server <span class="nb">type</span> veth peer name server-bridge
        <span class="c1"># add virtual interfaces to namespace</span>
        sudo ip link <span class="nb">set</span> client netns client-ns
        sudo ip link <span class="nb">set</span> server netns server-ns
        <span class="c1"># give addresses to each virtual interface</span>
        sudo ip netns <span class="nb">exec</span> client-ns ip addr add <span class="m">10</span>.0.0.2/24 dev client
        sudo ip netns <span class="nb">exec</span> server-ns ip addr add <span class="m">10</span>.0.0.1/24 dev server
        <span class="c1"># set virtual interfaces up</span>
        sudo ip netns <span class="nb">exec</span> client-ns ip link <span class="nb">set</span> client up
        sudo ip netns <span class="nb">exec</span> server-ns ip link <span class="nb">set</span> server up
        sudo ip link <span class="nb">set</span> client-bridge up
        sudo ip link <span class="nb">set</span> server-bridge up

        <span class="c1"># add bridge interface</span>
        sudo brctl addbr bridge0
        <span class="c1"># link virtual interfaces to bridge</span>
        sudo brctl add <span class="k">if</span> bridge0 client-bridge
        sudo brctl add <span class="k">if</span> bridge0 server-bridge
        <span class="c1"># set bridge up</span>
        sudo ip link <span class="nb">set</span> bridge0 up

        <span class="c1"># (in a new terminal) do stuff on the virtual interface</span>
        sudo ip netns <span class="nb">exec</span> client-ns ping <span class="m">10</span>.0.0.1

        <span class="c1"># set bridge down (simulate network offline)</span>
        sudo ip link <span class="nb">set</span> bridge0 down

        <span class="c1"># sometimes you might need to use the loopback interface</span>
        sudo ip netns <span class="nb">exec</span> client-ns ip link <span class="nb">set</span> lo up
        sudo ip netns <span class="nb">exec</span> server-ns ip link <span class="nb">set</span> lo up
        </pre></div>


        <h1 id="ubuntu-vnc-server">Ubuntu VNC Server</h1>
        <div class="codehilite"><pre><span></span><span class="c1"># install x11vnc</span>
        sudo apt install x11vnc
        <span class="c1"># create a password</span>
        x11vnc -storepasswd
        <span class="c1"># start the server</span>
        </pre></div>


        <p>To automatically run the server at login, add a startup script:</p>
        <div class="codehilite"><pre><span></span>gnome-session-properties
        </pre></div>


        <p>Add a new item called \"VNC\" with the command field set to</p>
        <div class="codehilite"><pre><span></span>x11-vnc -forever -loop -noxdamage -repeat -rfbport <span class="m">5900</span> -shared -usepw
        </pre></div>


        <p>Remember to set the machine to never suspend in the system power
        settings.</p>
        <h1 id="buildroot">Buildroot</h1>
        <h2 id="useful-options">Useful options</h2>
        <ul>
        <li>toolchain > enable wchar support</li>
        <li>bootloaders > grub2</li>
        <li>toolchain > C library</li>
        <li>filesystem images > iso image</li>
        </ul>
        </article>
    </main>
<footer>
    <p>Evan Widloski</p>
</footer>
</body>
</html>